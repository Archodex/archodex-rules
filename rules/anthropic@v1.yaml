Name: Anthropic API
Default: true
Mode: ai
Description: >-
  Monitors Anthropic API traffic. Captures API keys (hashed), model selection, and usage metrics including input/output
  token counts.

Rules:
  - Hostnames:
      - api.anthropic.com
    TransportRules:
      - Http:
          Request:
            Methods:
              - POST
            Routes: /v1/messages
            Headers:
              X-Api-Key:
                Regex: ^sk-ant-\S+$
            Body:
              Model:
                Path: $.model
              Prompt:
                Path: $.messages
              System:
                Path: $.system
                Required: false
              # Detect if caching is enabled in the request (optional - not all requests use caching)
              CacheControl:
                Path: $..cache_control.type
                Required: false
          Response:
            Headers:
              # Rate limit headers
              anthropic-ratelimit-input-tokens-limit: {}
              anthropic-ratelimit-input-tokens-remaining: {}
              anthropic-ratelimit-output-tokens-limit: {}
              anthropic-ratelimit-output-tokens-remaining: {}
              anthropic-ratelimit-requests-limit: {}
              anthropic-ratelimit-requests-remaining: {}
              # Request tracking
              request-id: {}
              # Organization info
              anthropic-organization-id: {}
            Body:
              # Model: $.model for JSON, $.message.model for SSE message_start
              Model:
                Path: $.model
                StreamingPath: $.message.model
              # AssistantResponse: $.content[*].text for JSON, $.delta.text for SSE content_block_delta
              AssistantResponse:
                Path: $.content[*].text
                StreamingPath: $.delta.text
              # Usage fields work the same for both JSON and SSE message_delta
              InputTokens:
                Path: $.usage.input_tokens
              OutputTokens:
                Path: $.usage.output_tokens
              # Cache metrics
              CacheCreationInputTokens:
                Path: $.usage.cache_creation_input_tokens
                Required: false
              CacheReadInputTokens:
                Path: $.usage.cache_read_input_tokens
                Required: false
          ResourceCaptures:
            - Type: Anthropic API
              Id: '{TlsServerName}'
              Contains:
                - Type: Model
                  Id: '{Request.BodyCaptures.Model | first}'
            - Type: Secret Value
              Id: "{Request.Headers['x-api-key'] | secret_value_hash}"
          EventCaptures:
            - Principals:
                - Event: Used
                  Resource:
                    - Type: Secret Value
                      Id: "{Request.Headers['x-api-key'] | secret_value_hash}"
              Events:
                - Types:
                    - Accessed
                  Resources:
                    - - Type: Anthropic API
                        Id: '{TlsServerName}'
                      - Type: Model
                        Id: '{Request.BodyCaptures.Model | first}'
              Attributes:
                # Standard OTel GenAI attributes
                gen_ai.request.model: '{Request.BodyCaptures.Model | first}'
                gen_ai.usage.input_tokens:
                  Value: '{Response.BodyCaptures.InputTokens | last}'
                  Type: Number
                gen_ai.usage.output_tokens:
                  Value: '{Response.BodyCaptures.OutputTokens | last}'
                  Type: Number
                gen_ai.response.id: "{Response.Headers['request-id'] | first}"
                # Anthropic-specific attributes
                archodex.anthropic.organization_id: "{Response.Headers['anthropic-organization-id'] | first}"
                archodex.anthropic.cache_enabled: '{Request.BodyCaptures.CacheControl | first}'
                archodex.anthropic.cache_write_tokens:
                  Value: '{Response.BodyCaptures.CacheCreationInputTokens | last}'
                  Type: Number
                archodex.anthropic.cache_read_tokens:
                  Value: '{Response.BodyCaptures.CacheReadInputTokens | last}'
                  Type: Number
                # Derived attributes
                gen_ai.operation.name: chat
                gen_ai.provider.name: anthropic
                gen_ai.capability.name: Anthropic Claude
              # Content as span events (per OTel GenAI spec)
              SpanEvents:
                gen_ai.client.inference.operation.details:
                  gen_ai.system_instructions: '{Request.BodyCaptures.System}'
                  gen_ai.input.messages: '{Request.BodyCaptures.Prompt | join("")}'
                  gen_ai.output.messages: '{Response.BodyCaptures.AssistantResponse | join("")}'
